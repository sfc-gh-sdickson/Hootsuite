-- ============================================================================
-- Hootsuite Streamlit App Generator Procedure
-- ============================================================================
-- Purpose: Automatically generate, deploy, and return clickable link to Streamlit app
-- Uses CREATE STREAMLIT ... AS $$code$$ for direct deployment
-- ============================================================================

USE DATABASE HOOTSUITE_INTELLIGENCE;
USE SCHEMA ANALYTICS;
USE WAREHOUSE HOOTSUITE_WH;

-- ============================================================================
-- Streamlit App Generator Procedure
-- ============================================================================
CREATE OR REPLACE PROCEDURE GENERATE_STREAMLIT_FROM_CHART(
    CHART_SQL TEXT,
    CHART_TITLE TEXT,
    ANALYSIS_TYPE TEXT
)
RETURNS VARIANT
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python')
HANDLER = 'main'
AS $$
import json

def main(session, CHART_SQL, CHART_TITLE, ANALYSIS_TYPE):
    """
    Generate and deploy a Streamlit app, return clickable link
    """
    
    # Clean app name for Snowflake
    app_name = CHART_TITLE.replace(' ', '_').replace('-', '_').upper()
    app_name = ''.join(c if c.isalnum() or c == '_' else '_' for c in app_name)
    app_name = f"HOOTSUITE_{app_name}"[:50]
    
    # Escape SQL for embedding
    chart_sql_clean = CHART_SQL.replace("'", "''")
    
    # Generate Streamlit app code
    streamlit_code = f"""import streamlit as st
import pandas as pd
import plotly.express as px
from snowflake.snowpark.context import get_active_session

session = get_active_session()
st.set_page_config(page_title="{CHART_TITLE}", layout="wide")

st.title("üìä {CHART_TITLE}")
st.markdown("*Interactive analysis powered by Snowflake*")
st.markdown("---")

@st.cache_data
def load_data():
    return session.sql('''{chart_sql_clean}''').to_pandas()

try:
    df = load_data()
    if df.empty:
        st.warning("No data returned")
        st.stop()
except Exception as e:
    st.error(f"Error: {{e}}")
    st.stop()

# Display data
col1, col2 = st.columns(2)
with col1:
    st.subheader("üìã Data Table")
    st.dataframe(df, use_container_width=True, height=400)
    st.caption(f"Total Records: {{len(df):,}}")

with col2:
    st.subheader("üéØ Quick Stats")
    numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
    if numeric_cols:
        for col in numeric_cols[:3]:
            st.metric(col, f"{{df[col].sum():,.0f}}", 
                     delta=f"Avg: {{df[col].mean():,.2f}}")

# Auto-generate charts
categorical_cols = df.select_dtypes(include=['object']).columns.tolist()

if categorical_cols and numeric_cols:
    st.subheader("üìä Visualizations")
    
    tab1, tab2 = st.tabs(["Bar Chart", "Distribution"])
    
    with tab1:
        fig_bar = px.bar(df, x=categorical_cols[0], y=numeric_cols[0],
                        title=f"{{numeric_cols[0]}} by {{categorical_cols[0]}}")
        st.plotly_chart(fig_bar, use_container_width=True)
    
    with tab2:
        fig_hist = px.histogram(df, x=numeric_cols[0], 
                               title=f"Distribution of {{numeric_cols[0]}}")
        st.plotly_chart(fig_hist, use_container_width=True)

# Statistical analysis
if numeric_cols and "{ANALYSIS_TYPE}" == "statistical":
    st.subheader("üìä Statistical Analysis")
    col1, col2 = st.columns(2)
    
    with col1:
        st.write("**Descriptive Statistics**")
        st.dataframe(df[numeric_cols].describe())
    
    with col2:
        if len(numeric_cols) > 1:
            st.write("**Correlations**")
            corr = df[numeric_cols].corr()
            fig = px.imshow(corr, text_auto=True, color_continuous_scale="RdBu_r")
            st.plotly_chart(fig, use_container_width=True)

# Interactive filtering
if categorical_cols:
    st.subheader("üîç Interactive Filtering")
    for col in categorical_cols[:3]:
        unique_vals = df[col].unique().tolist()
        if len(unique_vals) <= 20:
            selected = st.multiselect(f"Filter {{col}}", unique_vals, default=unique_vals)
            if selected != unique_vals:
                df = df[df[col].isin(selected)]
                st.info(f"Filtered to {{len(df):,}} records")
                st.dataframe(df, use_container_width=True)

# Export
st.subheader("üíæ Export")
csv = df.to_csv(index=False)
st.download_button("üì• Download CSV", csv, "data.csv", use_container_width=True)

if st.button("üîÑ Refresh Data"):
    st.cache_data.clear()
    st.rerun()

st.markdown("---")
st.caption("ü§ñ Auto-generated by Hootsuite Intelligence Agent")
"""
    
    try:
        # Create Streamlit app using AS $$STREAMLIT_CODE$$ syntax with custom delimiter
        create_sql = f"""
        CREATE OR REPLACE STREAMLIT HOOTSUITE_INTELLIGENCE.ANALYTICS.{app_name}
        MAIN_FILE = 'app.py'
        QUERY_WAREHOUSE = 'HOOTSUITE_WH'
        TITLE = '{CHART_TITLE}'
        AS
        $$STREAMLIT_CODE$${streamlit_code}$$STREAMLIT_CODE$$
        """
        
        session.sql(create_sql).collect()
        
        # Get account info for URL
        account_info = session.sql("SELECT CURRENT_ACCOUNT() as acct, CURRENT_REGION() as reg").collect()[0]
        account = account_info['ACCT']
        region = account_info['REG']
        
        # Build Snowsight URL
        app_url = f"https://app.snowflake.com/{region}/{account}/#/streamlit-apps/HOOTSUITE_INTELLIGENCE.ANALYTICS.{app_name}"
        
        return {
            "status": "success",
            "app_name": app_name,
            "app_url": app_url,
            "message": f"‚úÖ Streamlit app '{app_name}' deployed successfully!",
            "button_text": f"üöÄ Launch {CHART_TITLE}",
            "button_url": app_url
        }
        
    except Exception as e:
        return {
            "status": "error",
            "message": f"‚ùå Deployment failed: {str(e)}",
            "code": streamlit_code[:500] + "..."
        }

$$;

-- ============================================================================
-- Grant Permissions
-- ============================================================================
GRANT USAGE ON PROCEDURE HOOTSUITE_INTELLIGENCE.ANALYTICS.GENERATE_STREAMLIT_FROM_CHART(TEXT, TEXT, TEXT) TO ROLE SYSADMIN;
GRANT USAGE ON PROCEDURE HOOTSUITE_INTELLIGENCE.ANALYTICS.GENERATE_STREAMLIT_FROM_CHART(TEXT, TEXT, TEXT) TO ROLE PUBLIC;
GRANT CREATE STREAMLIT ON SCHEMA HOOTSUITE_INTELLIGENCE.ANALYTICS TO ROLE SYSADMIN;
GRANT CREATE STREAMLIT ON SCHEMA HOOTSUITE_INTELLIGENCE.ANALYTICS TO ROLE PUBLIC;

-- ============================================================================
-- Test Procedure (Commented out)
-- ============================================================================
-- CALL GENERATE_STREAMLIT_FROM_CHART(
--     'SELECT platform, COUNT(*) as post_count FROM HOOTSUITE_INTELLIGENCE.RAW.SOCIAL_ACCOUNTS GROUP BY platform',
--     'Platform Analysis',
--     'exploratory'
-- );

SELECT 'Streamlit App Generator Procedure created successfully' AS STATUS;

