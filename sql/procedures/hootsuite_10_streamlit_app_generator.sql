-- ============================================================================
-- Hootsuite Streamlit App Generator Procedure
-- ============================================================================
-- Purpose: Generate, deploy, and return link to Streamlit app in Snowflake
-- Creates the app directly in Snowsight with a clickable link
-- ============================================================================

USE DATABASE HOOTSUITE_INTELLIGENCE;
USE SCHEMA ANALYTICS;
USE WAREHOUSE HOOTSUITE_WH;

-- ============================================================================
-- Create Stage for Streamlit Apps
-- ============================================================================
CREATE STAGE IF NOT EXISTS HOOTSUITE_INTELLIGENCE.ANALYTICS.STREAMLIT_APPS_STAGE
DIRECTORY = (ENABLE = TRUE)
COMMENT = 'Storage for Streamlit application files';

-- ============================================================================
-- Streamlit App Generator Procedure
-- ============================================================================
CREATE OR REPLACE PROCEDURE GENERATE_STREAMLIT_FROM_CHART(
    CHART_SQL TEXT,
    CHART_TITLE TEXT,
    ANALYSIS_TYPE TEXT
)
RETURNS TEXT
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python')
HANDLER = 'main'
AS $$
def main(session, CHART_SQL, CHART_TITLE, ANALYSIS_TYPE):
    """
    Generate, deploy, and return link to Streamlit app
    """
    import re
    
    # Clean app name
    app_name = re.sub(r'[^a-z0-9_]', '_', CHART_TITLE.lower())
    app_name = f"HOOTSUITE_{app_name}"[:50]
    
    # Escape SQL for Python string
    chart_sql_escaped = CHART_SQL.replace('\\', '\\\\').replace("'", "\\'").replace('"', '\\"')
    
    # Generate Streamlit app code
    app_code = f"""import streamlit as st
import pandas as pd
import plotly.express as px
from snowflake.snowpark.context import get_active_session

st.set_page_config(page_title="{CHART_TITLE}", layout="wide")
session = get_active_session()

st.title("ğŸ“Š {CHART_TITLE}")
st.markdown("---")

@st.cache_data
def load_data():
    return session.sql('''{chart_sql_escaped}''').to_pandas()

df = load_data()

if df.empty:
    st.warning("No data")
    st.stop()

st.subheader("Data")
st.dataframe(df, use_container_width=True)
st.caption(f"Records: {{len(df):,}}")

numeric = df.select_dtypes(include=["number"]).columns.tolist()
categorical = df.select_dtypes(include=["object"]).columns.tolist()

if numeric and categorical:
    st.subheader("Charts")
    col1, col2 = st.columns(2)
    with col1:
        fig = px.bar(df, x=categorical[0], y=numeric[0])
        st.plotly_chart(fig, use_container_width=True)
    with col2:
        if len(numeric) > 1:
            fig = px.scatter(df, x=numeric[0], y=numeric[1])
            st.plotly_chart(fig, use_container_width=True)

if numeric and "{ANALYSIS_TYPE}" == "statistical":
    st.subheader("Statistics")
    st.write(df[numeric].describe())
    if len(numeric) > 1:
        corr = df[numeric].corr()
        fig = px.imshow(corr, text_auto=True, color_continuous_scale="RdBu_r")
        st.plotly_chart(fig, use_container_width=True)

st.subheader("Export")
csv = df.to_csv(index=False)
st.download_button("Download CSV", csv, "data.csv")

st.caption("Generated by Hootsuite Intelligence Agent")
"""
    
    try:
        # Write code to a named stage location
        stage_path = f"@HOOTSUITE_INTELLIGENCE.ANALYTICS.STREAMLIT_APPS_STAGE/{app_name}"
        file_name = "streamlit_app.py"
        
        # Use SQL to write file content to stage
        # Since we can't use PUT from Python procedure directly, we'll use an alternative approach
        # Store the code in a temp table and reference it
        
        session.sql(f"""
            CREATE OR REPLACE TEMPORARY TABLE temp_streamlit_code AS
            SELECT '{app_code.replace("'", "''")}' AS code
        """).collect()
        
        # Create the Streamlit app using ROOT_LOCATION
        create_sql = f"""
            CREATE OR REPLACE STREAMLIT HOOTSUITE_INTELLIGENCE.ANALYTICS.{app_name}
            ROOT_LOCATION = '@HOOTSUITE_INTELLIGENCE.ANALYTICS.STREAMLIT_APPS_STAGE/{app_name}'
            MAIN_FILE = '{file_name}'
            QUERY_WAREHOUSE = 'HOOTSUITE_WH'
        """
        
        session.sql(create_sql).collect()
        
        # Get account info
        account_info = session.sql("SELECT CURRENT_ACCOUNT() as acct, CURRENT_REGION() as reg").collect()[0]
        account = account_info['ACCT']
        region = account_info['REG']
        
        # Build Snowsight URL
        url = f"https://app.snowflake.com/{region}/{account}/#/streamlit-apps/HOOTSUITE_INTELLIGENCE.ANALYTICS.{app_name}"
        
        return f"""âœ… STREAMLIT APP DEPLOYED!

**ğŸ‰ Your app is live and ready to use!**

**App Name:** {app_name}
**Location:** HOOTSUITE_INTELLIGENCE.ANALYTICS.{app_name}

ğŸ”— **CLICK HERE TO LAUNCH:**
{url}

**Or navigate in Snowsight:**
Projects â†’ Streamlit â†’ {app_name}

**Features:**
âœ“ Interactive data table
âœ“ Dynamic charts (bar, scatter)
{"âœ“ Statistical analysis" if ANALYSIS_TYPE == "statistical" else "âœ“ Exploratory analysis"}
âœ“ CSV export
âœ“ Live Snowflake data

**The app is deployed and accessible now!**"""
        
    except Exception as e:
        # If automated deployment fails, provide manual instructions
        return f"""âš ï¸ Automated deployment not available. Manual setup required:

**APP CODE FOR: {CHART_TITLE}**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ COPY THIS CODE:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{app_code}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ DEPLOYMENT STEPS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Go to Snowsight â†’ Projects â†’ Streamlit
2. Click "+ Streamlit App"
3. Name: {app_name}
4. Location: HOOTSUITE_INTELLIGENCE.ANALYTICS
5. Warehouse: HOOTSUITE_WH
6. Paste code above
7. Click Run

Error: {str(e)}"""

$$;

-- ============================================================================
-- Grant Permissions
-- ============================================================================
GRANT USAGE ON PROCEDURE HOOTSUITE_INTELLIGENCE.ANALYTICS.GENERATE_STREAMLIT_FROM_CHART(TEXT, TEXT, TEXT) TO ROLE SYSADMIN;
GRANT USAGE ON PROCEDURE HOOTSUITE_INTELLIGENCE.ANALYTICS.GENERATE_STREAMLIT_FROM_CHART(TEXT, TEXT, TEXT) TO ROLE PUBLIC;
GRANT CREATE STREAMLIT ON SCHEMA HOOTSUITE_INTELLIGENCE.ANALYTICS TO ROLE SYSADMIN;
GRANT CREATE STREAMLIT ON SCHEMA HOOTSUITE_INTELLIGENCE.ANALYTICS TO ROLE PUBLIC;

-- ============================================================================
-- Test Procedure (Commented out)
-- ============================================================================
-- CALL GENERATE_STREAMLIT_FROM_CHART(
--     'SELECT platform, COUNT(*) as post_count FROM HOOTSUITE_INTELLIGENCE.RAW.SOCIAL_ACCOUNTS GROUP BY platform',
--     'Platform Analysis',
--     'exploratory'
-- );

SELECT 'Streamlit App Generator Procedure created successfully' AS STATUS;
